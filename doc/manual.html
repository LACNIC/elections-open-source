--- 
layout: default
title: Sistema Elecciones
link_logo: http://elecciones-demo.lacnic.net.uy/elecciones
link_title: http://elecciones-demo.lacnic.net.uy/elecciones
link_repo: https://github.com/LACNIC/elections-open-source
---
<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h1>{{ "Armado manual del ambiente" }}</h1>
      </div>
      <div class="ibox-content">
        <p class="paragraph">En esta sección se detallan los pasos para la instalación de los requisitos y despligue del aplicativo de elecciones manualmente. Se detallan instrucciones para los siguientes sistemas operativos:</p>
        <ul class="paragraph">
					<li><code>Ubuntu 18.4.05</code></li>
					<li><code>Debian 10</code></li>
					<li><code>CentOS 7.9</code></li>
        </ul>
        <p class="paragraph">En los tres casos se asumen que partiremos de una instalación limpia del sistema operativo contando con un usuario con permisos ssh y habilitado para sudo.</p>
        <p class="paragraph">A continuación se presentan los pasos para a realizar para la instalación manual y despliegue:</p>
        <ol class="paragraph vertical-space">
          <li><a href="#java">Instalación de Java 8</a></li>
          <li><a href="#auxiliares">Instalación de complementos y pre-requisitos</a></li>
          <li><a href="#wildfly">Instalación de Wildfly 20</a></li>
          <li><a href="#postgres">Instalación de PostgreSQL</a></li>
          <li><a href="#setupBDWildfly">Creación de la base de datos y configuración del servidor web.</a></li>   
          <li><a href="#deploy">Compilación y Despliegue</a></li>        
          <li><a href="#proxy">Reverse Proxy</a></li>        
          <li><a href="#configuracion">Configuración Inicial</a></li>        
        </ol>
      </div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="java">{{ "Instalación de Java 8" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">Es importante recalcar que la versión de java debe ser 8, ya que en versiones posteriores se requiere revisar las dependencias y versiones del compilador de Maven.</p>
        <h4 class="titulo-h4">Ubuntu</h4>
        <ul class="paragraph">
					<li>Actualizar el índice de paquetes: <code>sudo apt update</code></li>
					<li>Instalar Java 8: <code>sudo apt install openjdk-8-jdk</code></li>					
        </ul>
        <h4 class="titulo-h4">Debian</h4>
        <ul class="paragraph">
          <li>Actualizar el índice de paquetes: <code>sudo apt update</code></li>
          <li>Instalar GNU Privacy Guard: <code>sudo apt-get install gnupg</code></li>
          <li>Instalar Software Properties Common: <code>sudo apt-get install software-properties-common</code></li>
          <li>Actualizar el índice de paquetes: <code>sudo apt update</code></li>
          <li>Importar llave de repositorio: <code>wget -qO - https://adoptopenjdk.jfrog.io/adoptopenjdk/api/gpg/key/public | sudo apt-key add -</code></li>
          <li>Instalar el repositorio: <code>sudo add-apt-repository "deb https://adoptopenjdk.jfrog.io/adoptopenjdk/deb buster main"</code></li>
          <li>Actualizar el índice de paquetes: <code>sudo apt update</code></li>
          <li>Instalar Java 8: <code>sudo apt install adoptopenjdk-8-hotspot</code></li>					
        </ul>
        <h4 class="titulo-h4">CentOS / Redhat</h4>
        <ul class="paragraph">
					<li>Actualizar el índice de paquetes: <code>sudo yum -y update</code></li>
					<li>Instalar Java 8: <code>sudo yum install openjdk-8-jdk</code></li>					
        </ul>
      </div>
		</div>
	</div>
</div>   
<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="auxiliares">{{ "Instalación complementos y auxiliares" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">A continuación se deben instalar los siguientes aplicativos que utilizaremos</p>
        <ul class="paragraph">
					<li>unzip</li>
          <li>maven</li>					
          <li>git</li>					
          <li>curl</li>					
          <li>python-simplejson</li>					
          <li>python-pip</li>					
          <li>python-dev</li>	        			
        </ul>      
        <h4 class="titulo-h4">Ubuntu / Debian</h4>
        <ul class="paragraph">
					<li>Actualizar el índice de paquetes: <code>sudo apt update</code></li>
          <li>Instalar unzip: <code>sudo apt-get install unzip</code></li>					
          <li>Instalar maven: <code>sudo apt install maven</code></li>					
          <li>Instalar git: <code>sudo apt install git</code></li>					
          <li>Instalar curl: <code>sudo apt install curl</code></li>					
          <li>Instalar python-simplejson: <code>sudo apt-get install python-simplejson</code></li>					
          <li>Instalar python-pip: <code>sudo apt install python-pip</code></li>					
          <li>Instalar python-dev: <code>sudo apt-get install python-dev</code></li>					
        </ul>
        <h4 class="titulo-h4">CentOS / Redhat</h4>
        <ul class="paragraph">
					<li>Actualizar el índice de paquetes: <code>sudo yum -y update</code></li>
          <li>Instalar unzip: <code>sudo yum install unzip</code></li>          					
          <li>Instalar git: <code>sudo yum install git</code></li>					
          <li>Instalar curl: <code>sudo yum install curl</code></li>		
          <li>Instalar wget: <code>sudo yum install wget</code></li>
          <li>Instalar nano: <code>sudo yum install nano</code></li>	
          <li>Instalar maven, en este caso vamos a realizar la instalación manual de la versión 3.6.3 debido a que la instalación con yum instala la versión 3.0.X y no es posible compilar el proyecto.
            <ul>
              <li>Descargar los binarios: <code>sudo wget https://espejito.fder.edu.uy/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz -P /tmp</code></li>
              <li>Descromprimirlos: <code>sudo tar xf /tmp/apache-maven-3.6.3-bin.tar.gz -C /opt</code></li>
              <li>Crear el link: <code>sudo ln -s /opt/apache-maven-3.6.3 /opt/maven</code></li>
              <li>Crear el archivo maven.sh: <code>sudo nano /etc/profile.d/maven.sh</code> agregar las líneas:
                <ul>
                 <li><code>export JAVA_HOME=/usr/lib/jvm/jre-openjdk</code></li> 
                 <li><code>export M2_HOME=/opt/maven</code></li> 
                 <li><code>export MAVEN_HOME=/opt/maven</code></li> 
                 <li><code>export PATH=${M2_HOME}/bin:${PATH}</code></li> 
                </ul>
              </li>
              <li>Dar permisos: <code>sudo chmod +x /etc/profile.d/maven.sh</code></li> 
              <li>Ejecutar: <code>source /etc/profile.d/maven.sh</code></li>
            </ul>
          </li>	
				</ul>
      </div>
		</div>
	</div></code>
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="wildfly">{{ "Instalación de Wildfly" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">Como servidor web se utilizara Wildfly 20. A Continuación las actividades para instalarlo y configurarlo.</p>
        <h4 class="titulo-h4">Ubuntu / Debian</h4>
        <ul class="paragraph">
					<li>Creación de grupo y usuario:
            <ul>
              <li><code>sudo addgroup jboss</code></li>
              <li><code>sudo useradd -g jboss jboss</code></li>
            </ul>
          </li>
          <li>Descargar Wildfly 20: <code>wget https://download.jboss.org/wildfly/20.0.1.Final/wildfly-20.0.1.Final.zip -P /tmp</code></li>					
          <li>Descromprimirlo en /opt: <code>sudo unzip  /tmp/wildfly-20.0.1.Final.zip -d /opt/</code></li>
          <li>Crear link <code>sudo ln -s /opt/wildfly-20.0.1.Final /opt/wildfly</code></li>
          <li>Asignar permisos a usuario: <code>sudo chown -RH jboss: /opt/wildfly</code></li>
          <li>Respaldar la configuración inicial (standalone.xml): <code>sudo cp /opt/wildfly/standalone/configuration/standalone.xml /opt/wildfly/standalone/configuration/standalone.xml.original</code></li>
          <li>Creación de servicio
            <ul>
              <li>Creación de archivo de servicio:  <code>sudo nano /etc/systemd/system/jboss.service</code></li>
              <li>Contenido del archivo:
                <ul>              
                  <li><b>Ubuntu</b> - Contenido de ejemplo <a href="https://github.com/LACNIC/elections-open-source/blob/ansibleMultiOS/ansible/roles/elecciones/templates/systemd_jboss_ubuntu.j2">aquí</a></li>
                  <li><b>Debian</b> - Contenido de ejemplo <a href="https://github.com/LACNIC/elections-open-source/blob/ansibleMultiOS/ansible/roles/elecciones/templates/systemd_jboss_debian.j2">aquí</a></li>
                </ul>
              </li>
              <li>Inicio del servicio: <code>sudo systemctl start jboss.service</code></li>
              <li>Seteo del servicio: <code>sudo systemctl enable jboss.service</code></li>
            </ul>
          </li>
          <li>Creación de usuario administrador de Wildfly: <code>sudo /opt/wildfly/bin/add-user.sh</code></li>
        </ul>
        <h4 class="titulo-h4">CentOS / Redhat</h4>
        <ul class="paragraph">
					<li>Creación de grupo y usuario:
            <ul>
              <li><code>sudo groupadd -r jboss</code></li>
              <li><code>sudo useradd -r -g jboss -d /opt/wildfly -s /sbin/nologin jboss</code></li>
            </ul>
          </li>
          <li>Descargar Wildfly 20: <code>wget https://download.jboss.org/wildfly/20.0.1.Final/wildfly-20.0.1.Final.zip -P /tmp</code></li>					
          <li>Descromprimirlo en /opt: <code>sudo unzip  /tmp/wildfly-20.0.1.Final.zip -d /opt/</code></li>
          <li>Crear link <code>sudo ln -s /opt/wildfly-20.0.1.Final /opt/wildfly</code></li>
          <li>Asignar permisos a usuario: <code>sudo chown -RH jboss: /opt/wildfly</code></li>
          <li>Respaldar la configuración inicial (standalone.xml): <code>sudo cp /opt/wildfly/standalone/configuration/standalone.xml /opt/wildfly/standalone/configuration/standalone.xml.original</code></li>
          <li>Creación de servicio
            <ul>
              <li>Creación de archivo de servicio:  <code>sudo nano /etc/systemd/system/jboss.service</code></li>
              <li>Contenido de ejemplo <a href="https://github.com/LACNIC/elections-open-source/blob/ansibleMultiOS/ansible/roles/elecciones/templates/systemd_jboss_rh-centos.j2">aquí</a></li>
              <li>Inicio del servicio: <code>sudo systemctl start jboss.service</code></li>
              <li>Seteo del servicio: <code>sudo systemctl enable jboss.service</code></li>
            </ul>
          </li>
          <li>Creación de usuario administrador de Wildfly: <code>sudo /opt/wildfly/bin/add-user.sh</code></li>
				</ul>
      </div>
		</div>
	</div>
</div>  
<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="postgres">{{ "Instalación de PostgreSQL" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">Como servidor de base de datos utilizaremos PostgreSQL 12. A continuación se detallan las actividades para la instalación y configuración.</p>
        <h4 class="titulo-h4">Ubuntu</h4>
        <ul class="paragraph">
					<li>Creación de grupo y usuario:
            <ul>
              <li><code>sudo addgroup postgres</code></li>
              <li><code>sudo useradd -g postgres postgres</code></li>
            </ul>
          </li>
          <li>Importación de la llave: <code> wget -O - http://apt.postgresql.org/pub/repos/apt/ACCC4CF8.asc | sudo apt-key add -</code></li>
          <li>Instalación del repositorio: <code>sudo add-apt-repository "deb http://apt.postgresql.org/pub/repos/apt bionic-pgdg main"</code></li>
          <li>Actualizar el índice de paquetes: <code>sudo apt update</code></li>
          <li>Instalación de Auxiliares: <code>sudo apt install libpq-dev python-psycopg2</code></li>
          <li>Instalación de PostgreSQL 12: <code>sudo apt install postgresql-12 postgresql-client-12</code></li>
          <li>Creación de usuario de la BD:
            <ul>
              <li>Cambiar a postgre:<code>sudo su - postgres</code></li>
              <li>Crear el usuario: <code> createuser usuario_bd --password</code></li>
              <li>Modificar password: <code> psql -c "alter user usuario_bd with password 'usuario_bd_pwd'"</code></li>
            </ul>
          </li>
        </ul>
        <h4 class="titulo-h4">Debian</h4>
        <ul class="paragraph">
					<li>Creación de grupo y usuario:
            <ul>
              <li><code>sudo addgroup postgres</code></li>
              <li><code>sudo useradd -g postgres postgres</code></li>
            </ul>
          </li>
          <li>Importación de la llave: <code> wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -</code></li>
          <li>Instalación del repositorio: <code>sudo add-apt-repository "deb http://apt.postgresql.org/pub/repos/apt buster-pgdg main"</code></li>
          <li>Actualizar el índice de paquetes: <code>sudo apt update</code></li>
          <li>Instalación de Auxiliares: <code>sudo apt install libpq-dev python-psycopg2</code></li>
          <li>Instalación de PostgreSQL 12: <code>sudo apt install postgresql-12 postgresql-client-12</code></li>
          <li>Creación de usuario de la BD:
            <ul>
              <li>Cambiar a postgre:<code>sudo su - postgres</code></li>
              <li>Crear el usuario: <code> createuser usuario_bd --password</code></li>
              <li>Modificar password: <code> psql -c "alter user usuario_bd with password 'usuario_bd_pwd'"</code></li>
            </ul>
          </li>
        </ul>
        <h4 class="titulo-h4">CentOS / Redhat</h4>
        <ul class="paragraph">
					<li>Creación de grupo y usuario:
            <ul>
              <li><code>sudo groupadd -r postgres</code></li>
              <li><code>sudo useradd -m -r -g postgres postgres</code></li>
            </ul>
          </li>          
          <li>Instalación del repositorio: <code>sudo yum -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</code></li>
          <li>Instalación de Auxiliares: <code>sudo yum install python-psycopg2</code></li>
          <li>Instalación de PostgreSQL 12: <code>sudo yum install postgresql-12 postgresql12-server postgresql12-libs</code></li>
          <li>Inicialización de la BD: <code>sudo /usr/pgsql-12/bin/postgresql-12-setup initdb</code></li>
          <li>Respaldar la configuración inicial: <code>sudo cp /var/lib/pgsql/12/data/pg_hba.conf /var/lib/pgsql/12/data/pg_hba.conf.original</code></li>
          <li>Configuración de acceso a PostgreSQL con usr/pwd para conexiones locales, tomar el archivo pg_hba.conf de <a href="https://github.com/LACNIC/elections-open-source/blob/main/ansible/roles/elecciones/files/db/pg_hba.conf">aquí</a> y copiarlo en <code>/var/lib/pgsql/12/data/pg_hba.conf</code></li>
          <li>Inicio del servicio: <code>sudo systemctl start postgresql-12.service</code></li>
              <li>Seteo del servicio: <code>sudo systemctl enable postgresql-12.service</code></li>
          <li>Creación de usuario de la BD:
            <ul>
              <li>Cambiar a postgre:<code>sudo su - postgres</code></li>
              <li>Crear el usuario: <code> createuser usuario_bd --password</code></li>
              <li>Modificar password: <code> psql -c "alter user usuario_bd with password 'usuario_bd_pwd'"</code></li>
            </ul>
          </li>
        </ul>
      </div>
		</div>
	</div>
</div>  
<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="setupBDWildfly">{{ "Creación de la base de datos y configuración del servidor web" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">A continuación se detallan las tareas para crear y restaurar la base de datos inicial del sistema de elecciones.</p>
        <h4 class="titulo-h4">Ubuntu / Debian / CentOS / Redhat</h4>
        <ul class="paragraph">
          <li>Obtener el dump de la base de datos de <a href="https://github.com/LACNIC/elections-open-source/blob/main/ansible/roles/elecciones/files/db/elecciones.zip">aquí</a> y copiarlo en <code>/opt/dumps/</code></li>
          <li>Descromprimirlo: <code>sudo unzip elecciones.zip</code></li>
          <li>Impersonar el usuario postgres: <code>sudo su - postgres</code></li>					
          <li>Crear la base de datos "elecciones" para el usuario de bd creado: <code>createdb elecciones -O usuario_db</code> </li>
          <li>Restaurar la Base de datos: <code> psql -U postgres -d elecciones < /opt/dumps/elecciones.sql</code></li>
          <li>Brindar acceso al usuario de la base de datos, conectarse con el usuario postgre a la BD:<code> psql -d elecciones </code>
            <ul>
              <li><code>GRANT USAGE on SCHEMA public to usuario_db;</code></li>
              <li><code>GRANT ALL PRIVILEGES ON DATABASE elecciones TO usuario_db;</code></li>
              <li><code>GRANT SELECT, USAGE ON ALL SEQUENCES IN SCHEMA public TO usuario_db;</code></li>
              <li><code>GRANT SELECT,INSERT,UPDATE,DELETE ON ALL TABLES IN SCHEMA public TO usuario_db;</code></li>
            </ul>
          </li>          
        </ul>
        <p class="paragraph">A continuación se detallan las tareas para configurar el servidor de web para que funcione con PostgreSQL y acceda a la base de datos.</p>
        <h4 class="titulo-h4">Ubuntu / Debian / CentOS / Redhat</h4>
        <ul class="paragraph">
          <li>Detener el servicio del Wildfy: <code>sudo service jboss stop</code></li>
          <li>Descargar el driver de postgre de <a href="https://github.com/LACNIC/elections-open-source/blob/main/ansible/roles/elecciones/files/postgresql-42.2.16.jar">aquí</a> y copiarlo en <code>/opt/wildfly/standalone/deployments/</code></li>
          <li>Descargar los módulos <code>jxl</code>, <code>ipresource</code> y <code>commons-validator</code> de <a href="https://github.com/LACNIC/elections-open-source/tree/main/ansible/roles/elecciones/files/modules">aquí</a> y copiarlos en <code>/opt/wildfly/modules/system/layers/base/</code></li>
          <li>Agregar el origen de datos en el archivo standalone.xml en <code>/opt/wildfly/standalone/configuration/standalone.xml</code>, basarse en el archivo <a href= "https://github.com/LACNIC/elections-open-source/blob/main/ansible/roles/elecciones/templates/standalone.xml.j2">este</a></li>
          <li>Levantar el servicio del Wildfy: <code>sudo service jboss start</code></li>
        </ul>
      </div>
		</div>
	</div>
</div>  

<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="despliegue">{{ "Compilación y Despliegue" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">Existen dos formas para realizar el compilado y despligue, la más simple es tomando los compilados ya generados (.war y .jar) y la otra utilizar Maven para compilar el código y luego mediante un usuario administrador del servidor Wildfly realizar el despliegue. En este caso vamos a mostrar ambas formas.</p>
        <p class="paragraph">A continuación se detallan las instrucciones para realizar el despliegue del aplicativo asumiendo que se tiene los compilados</p>
        <h4 class="titulo-h4">Ubuntu / Debian / CentOS / Redhat</h4>
        <ul class="paragraph">
          <li>Para esto se asume que ya el usuario ha generado los siguiente compilados:
            <ul>
              <li><code>elecciones-ejb.jar</code></li>
              <li><code>elecciones-ws.war</code></li>
              <li><code>elecciones.war</code></li>
            </ul>
          </li>
          <li>Para hacer el despliegue se deben copiar estos archivos en: <code>/opt/wildfly/standalone/deployments/</code> y el servidor web realizará el despliegue.</li>                    
        </ul>
        <p class="paragraph">A continuación se detallan las actividades para compilar el código y desplegarlo tomando las fuentes directamente del repositorio.</p>
        <ul class="paragraph">
          <li>Clonar el repositorio Git: <code>git clone https://github.com/LACNIC/elections-open-source</code></li>
          <li>Compilar utilizando Maven en la carpeta del proyecto: <code>sudo mvn clean install</code></li>
          <li>Actualizar la información del servidor Wildfly en el de configuración de Maven: <code>sudo nano /etc/maven/settings.xml</code> agregando la información del servidor, un id, el usuario administrador y el password.</li>
          <li>Realizar el despliegue <code>sudo mvn wildfly:deploy-only -Dwildfly.id=wildfly-elecciones -Dwildfly.hostname=localhost -Dwildfly.port=9990</code> el campo <code>wildfly.id</code> hace referencia a la información del servidor ingresada en el paso anterior.</li>
        </ul>
      </div>
		</div>
	</div>
</div> 
<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="proxy">{{ "Reverse Proxy" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">Luego de completar las actividades anteriores notaran que el aplicativo esta levantado, pero se esta accediendo directamente al puerto 8080 del servidor web. Esto es algo aceptable para un ambiente de pruebas o local, pero NO es lo recomandado para un ambiente de producción, por lo que se se recomienda fuertemente instalar un proxy delante del servidor web.</p>        
        <p class="paragraph">En este manual no se detallaran las instrucciones para la instalación de este tipo de servidor ya que esta orientado a la generación del sitio demo y guiar una primera instalación. Si recomendamos la utilización del mismo.</p>        
      </div>
		</div>
	</div>
</div> 
<div class="row">
	<div class="col-lg-12">
		<div class="ibox">
			<div class="ibox-title">
				<h2 id="configuracion">{{ "Configuración Inicial" }}</h2>
      </div>
      <div class="ibox-content">  
        <p class="paragraph">Finalmente, lo que queda por realizar es la configuracion inicial del sitio. Esto se realiza dentro del mismo aplicativo.</p>        
        <p class="paragraph">Para realizarlo, por favor referirse al siguiente <a href='assets/images/EleccionesConfiguracionInicial.pdf' target="_blank">documento</a>.</p>        
      </div>
		</div>
	</div>
</div> 

  
